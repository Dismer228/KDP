services:
  # Ultravox Service (inference server) - FIXED VERSION COMPATIBILITY
  ultravox:
    image: pytorch/pytorch:2.3.0-cuda11.8-cudnn8-runtime
    container_name: ultravox-server
    volumes:
      - ./ultravox:/app
      - ./models:/models
    working_dir: /app
    ports:
      - "8000:8000"
    environment:
      - CUDA_VISIBLE_DEVICES=0
    command: >
      bash -c "
      pip install --upgrade pip &&
      pip install transformers==4.44.0 torch==2.3.0 torchaudio==2.3.0 fastapi==0.104.1 uvicorn[standard]==0.24.0 librosa python-multipart &&
      python server.py
      "
    networks:
      - ultravox-net
    restart: unless-stopped
    
  # TTS Service with Coqui TTS (fallback option) - DISABLED
  # Coqui TTS has poor Lithuanian support compared to Azure
  # Uncomment below if you want to use it for other languages
  # coqui-tts:
  #   image: ghcr.io/coqui/tts:latest
  #   container_name: coqui-tts
  #   ports:
  #     - "5002:5002"
  #   command: python3 -m TTS.server.server
  #   networks:
  #     - ultravox-net
  #   restart: unless-stopped

  # Azure TTS Service using REST API (no SDK issues!)
  azure-tts-proxy:
    build:
      context: .
      dockerfile: Dockerfile.azure-rest
    container_name: azure-tts-proxy
    ports:
      - "5003:5003"
    environment:
      - AZURE_SPEECH_KEY=${AZURE_SPEECH_KEY}
      - AZURE_SPEECH_REGION=${AZURE_SPEECH_REGION:-westeurope}
    networks:
      - ultravox-net
    restart: unless-stopped

networks:
  ultravox-net:
    driver: bridge